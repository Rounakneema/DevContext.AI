AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: DevContext AI Backend - Production-Grade Normalized Schema

Parameters:
  CognitoUserPoolId:
    Type: String
    Description: Cognito User Pool ID
    Default: ""
  CognitoClientId:
    Type: String
    Description: Cognito App Client ID
    Default: ""

Globals:
  Function:
    Timeout: 180
    MemorySize: 1024
    Runtime: nodejs18.x
    Environment:
      Variables:
        MAIN_TABLE: !Ref MainTable
        CACHE_BUCKET: !Ref CacheBucket
        BEDROCK_REGION: ap-southeast-1
        COGNITO_USER_POOL_ID: !Ref CognitoUserPoolId
        COGNITO_CLIENT_ID: !Ref CognitoClientId

Resources:
  # ============================================================================
  # SINGLE TABLE DESIGN (Normalized with Composite Keys)
  # ============================================================================
  
  MainTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: devcontext-main
      BillingMode: PAY_PER_REQUEST
      
      # Primary Key: PK (partition) + SK (sort)
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
      
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      
      # GSI1: User lookups (email, user's analyses, user's sessions)
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        
        # GSI2: Repository deduplication/caching
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      
      # TTL for automatic data expiration
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      
      # Point-in-time recovery for production
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      
      # Server-side encryption
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
      
      Tags:
        - Key: Environment
          Value: Production
        - Key: Application
          Value: DevContext-AI

  # ============================================================================
  # S3 BUCKET FOR REPOSITORY CACHE
  # ============================================================================
  
  CacheBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub devcontext-cache-${AWS::AccountId}
      
      # Lifecycle: Delete after 24 hours
      LifecycleConfiguration:
        Rules:
          - Id: DeleteAfter24Hours
            Status: Enabled
            ExpirationInDays: 1
      
      # Encryption at rest
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      
      # Block public access
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      
      # Versioning for data protection
      VersioningConfiguration:
        Status: Enabled
      
      Tags:
        - Key: Environment
          Value: Production
        - Key: Application
          Value: DevContext-AI

  # ============================================================================
  # API GATEWAY WITH COGNITO AUTHORIZER
  # ============================================================================
  
  DevContextApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      
      # CORS configuration
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
        MaxAge: "'3600'"
      
      # Cognito authentication
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoUserPoolId}
        AddDefaultAuthorizerToCorsPreflight: false
      
      # Throttling
      MethodSettings:
        - ResourcePath: '/*'
          HttpMethod: '*'
          ThrottlingBurstLimit: 100
          ThrottlingRateLimit: 50
      
      Tags:
        Environment: Production
        Application: DevContext-AI

  # ============================================================================
  # LAMBDA FUNCTIONS
  # ============================================================================
  
  OrchestratorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/
      Handler: orchestrator.handler
      Timeout: 180
      Environment:
        Variables:
          REPO_PROCESSOR_FUNCTION: !Ref RepoProcessorFunction
          STAGE1_FUNCTION: !Ref Stage1Function
          STAGE2_FUNCTION: !Ref Stage2Function
          STAGE3_FUNCTION: !Ref Stage3Function
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - S3CrudPolicy:
            BucketName: !Ref CacheBucket
        - Statement:
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource: '*'
      Events:
        Analyze:
          Type: Api
          Properties:
            RestApiId: !Ref DevContextApi
            Path: /analyze
            Method: post
        GetAnalysis:
          Type: Api
          Properties:
            RestApiId: !Ref DevContextApi
            Path: /analysis/{id}
            Method: get
        GetStatus:
          Type: Api
          Properties:
            RestApiId: !Ref DevContextApi
            Path: /analysis/{id}/status
            Method: get
        ListAnalyses:
          Type: Api
          Properties:
            RestApiId: !Ref DevContextApi
            Path: /analyses
            Method: get

  RepoProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/
      Handler: repo-processor.handler
      Timeout: 180
      MemorySize: 1024
      EphemeralStorage:
        Size: 2048
      Layers:
        - arn:aws:lambda:ap-southeast-1:553035198032:layer:git-lambda2:8
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref CacheBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable

  Stage1Function:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/
      Handler: stage1-review.handler
      Timeout: 120
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - S3ReadPolicy:
            BucketName: !Ref CacheBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: '*'

  Stage2Function:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/
      Handler: stage2-intelligence.handler
      Timeout: 180
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - S3ReadPolicy:
            BucketName: !Ref CacheBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: '*'

  Stage3Function:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/
      Handler: stage3-questions.handler
      Timeout: 180
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - S3ReadPolicy:
            BucketName: !Ref CacheBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: '*'

  AnswerEvalFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/
      Handler: answer-eval.handler
      Timeout: 30
      MemorySize: 512
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: '*'
      Events:
        SubmitAnswer:
          Type: Api
          Properties:
            RestApiId: !Ref DevContextApi
            Path: /interview/{sessionId}/answer
            Method: post
        GetSession:
          Type: Api
          Properties:
            RestApiId: !Ref DevContextApi
            Path: /interview/{sessionId}
            Method: get

  # ============================================================================
  # CLOUDWATCH ALARMS
  # ============================================================================
  
  OrchestratorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: DevContext-Orchestrator-Errors
      AlarmDescription: Alert when orchestrator has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref OrchestratorFunction

  DynamoDBThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: DevContext-DynamoDB-Throttles
      AlarmDescription: Alert when DynamoDB is throttling
      MetricName: UserErrors
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TableName
          Value: !Ref MainTable

# ============================================================================
# OUTPUTS
# ============================================================================

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub https://${DevContextApi}.execute-api.${AWS::Region}.amazonaws.com/prod/
    Export:
      Name: DevContext-ApiEndpoint
  
  MainTableName:
    Description: Main DynamoDB table name
    Value: !Ref MainTable
    Export:
      Name: DevContext-MainTable
  
  CacheBucketName:
    Description: S3 cache bucket name
    Value: !Ref CacheBucket
    Export:
      Name: DevContext-CacheBucket
  
  OrchestratorFunctionArn:
    Description: Orchestrator Lambda ARN
    Value: !GetAtt OrchestratorFunction.Arn
    Export:
      Name: DevContext-OrchestratorArn
